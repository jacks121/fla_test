# FLA 花苗流程管理系统 — 功能文档

> 版本：1.0.0 | 逆向整理自源代码 | 更新日期：2026-02-12

---

## 1. 项目概述

FLA（花苗流程 / Flower Seedling Automation）是一个用于追踪花苗培养工作流程的 POC 系统，核心围绕条码扫描展开。系统为移动端优先的单页应用，支持记录花苗（植物培养物）的创建、拆分、合并、上架、状态更新和转移等操作。

### 1.1 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 前端 | Vanilla JS + Vite | 无框架，Vite 仅用于开发/构建 |
| 后端 | Express.js + Node.js | 无构建步骤，直接运行 |
| 数据库 | SQLite (better-sqlite3) | WAL 模式，预编译语句 |
| 扫码 | html5-qrcode | 浏览器端摄像头扫码 |
| 标签 | qrcode | 二维码生成与打印 |
| 测试 | Vitest + Supertest | 单元测试 + 集成测试 |
| 部署 | PM2 | 单实例，自动重启 |

---

## 2. 核心领域概念

| 概念 | 英文 | ID 格式 | 说明 |
|------|------|---------|------|
| 花苗 | Plant | `P-N` | 单株植物，有品种、阶段、状态，绑定一个培养皿 |
| 培养皿 | Dish | `D-N` | 容器，引用一株花苗，ID 不复用 |
| 盘子 | Tray | `T-NN` | 物理容器，承载多个培养皿 |
| 位置 | Location | `rack-XX` | 货架/层/位，用于上架定位 |
| 事件 | Event | UUID | 不可变操作记录，含输入ID、输出ID、元数据、操作人、时间戳 |

### 2.1 枚举值

| 类别 | 可选值 |
|------|--------|
| 品种 (type) | 品种A、品种B、合并苗 |
| 阶段 (stage) | 萌发、生长、分化 |
| 状态 (status) | 正常、感染、变异 |

### 2.2 花苗与培养皿关系

- 每株花苗绑定且仅绑定一个培养皿（通过 `dishId`）
- 每个培养皿引用且仅引用一株花苗（通过 `plantId`）
- 转移操作可将花苗从旧皿移到新皿

---

## 3. 用户角色与权限

| 角色 | 说明 | 权限 |
|------|------|------|
| `admin` (管理员) | 系统管理 | 所有操作 + 管理员专属接口（用户列表） |
| `operator` (操作员) | 日常操作 | 创建/拆分/合并/上架/状态/转移/撤销 |

### 3.1 默认账号

| 用户名 | 密码 | 角色 | 内部 ID |
|--------|------|------|---------|
| admin | admin | admin | admin-001 |
| demo | demo | operator | user-001 |

> 生产环境请务必修改默认密码。

---

## 4. 认证与会话

### 4.1 登录流程

1. 用户在登录页输入账号和口令
2. `POST /api/login` 验证凭据
3. 服务端用 scrypt 对比密码哈希
4. 验证通过后生成 UUID 会话令牌，有效期 **7 天**
5. 客户端存储令牌至 `localStorage`（`fla_token`、`fla_user`）
6. 后续所有请求在 `Authorization: Bearer {token}` 头部携带令牌

### 4.2 会话管理

- 每次请求经中间件校验令牌有效性
- 过期会话自动删除，返回 401
- 登出时主动删除服务端会话记录

### 4.3 安全机制

| 机制 | 说明 |
|------|------|
| 密码哈希 | scrypt + 16 字节随机盐，存储格式 `{salt}.{hash}` |
| 恒定时间比较 | `timingSafeEqual` 防止计时攻击 |
| 登录限速 | 每 IP 每分钟最多 5 次尝试，超限返回 429 |
| 通用错误消息 | 登录失败统一返回"账号或口令错误"，不泄露用户是否存在 |
| 管理员路由保护 | 非管理员访问 `/api/admin/*` 返回 403 |

---

## 5. 功能模块详述

系统主界面由底部 Tab 栏分为 4 个功能标签页，另有标签打印和管理页面。

### 5.1 Tab 1：拆分/合并

此标签页包含三种模式，通过下拉框切换：

#### 5.1.1 创建（入库）

**用途**：批量创建新花苗并入库

| 字段 | 类型 | 说明 |
|------|------|------|
| 品种 | 下拉 | 品种A / 品种B |
| 阶段 | 下拉 | 萌发 / 生长 / 分化 |
| 数量 | 数字 | 1–50，默认 3 |
| 盘子编号 | 扫码/手输 | 如 T-01 |

**业务规则**：
- 自动生成 N 株花苗（`P-{自增}`）和 N 个培养皿（`D-{自增}`）
- 新花苗状态默认为"正常"
- 所有创建在一个数据库事务中完成

#### 5.1.2 拆分

**用途**：从一个父培养皿拆分出多个子代

| 字段 | 类型 | 说明 |
|------|------|------|
| 父培养皿 ID | 扫码/手输 | 如 D-1 |
| 盘子编号 | 扫码/手输 | 目标盘子 |
| 拆分数量 | 数字 | 1–50，默认 3 |

**业务规则**：
- 父培养皿必须存在且关联有效花苗
- 子代继承父代的品种和阶段
- 子代状态默认为"正常"
- 父代花苗/培养皿保持不变

#### 5.1.3 合并

**用途**：将多个父培养皿中的花苗合并为一株

| 字段 | 类型 | 说明 |
|------|------|------|
| 合并后盘子编号 | 扫码/手输 | 目标盘子 |
| 新培养皿编号 | 扫码/手输 | 可选，不填则自动生成 |
| 父培养皿（多个） | 队列输入 | 支持连续扫码、手动添加、逗号分隔粘贴 |

**队列管理**：
- 手动输入 + 回车/点"加入"
- "连扫"按钮保持摄像头常开，逐个扫码添加
- 重复扫码提示"X 已在队列"
- 支持逗号分隔批量粘贴
- 可单独移除或一键清空

**业务规则**：
- 至少一个父培养皿
- 合并后花苗品种固定为"合并苗"，阶段为"萌发"，状态为"正常"
- 新培养皿编号不可与父培养皿重复，不可已被占用
- 父代花苗/培养皿不会被删除，仅记录在事件 inputIds 中

---

### 5.2 Tab 2：上架

**用途**：批量将盘子放置到指定货架位置

**两阶段工作流**：

**第一步 — 锁定位置**：
- 选择或扫码输入上架位置（如 `rack-A1`）
- 点击"锁定位置"

**第二步 — 添加盘子**：
- 位置锁定后显示为徽章
- 逐一添加盘子编号（扫码/手输）
- 支持"连扫"批量添加
- 重复盘子提示"已在队列中"
- 点击"完成上架"提交
- 可点击"更换位置"返回第一步

**业务规则**：
- 为队列中每个盘子分别创建一条 `place` 事件
- 上架操作不修改花苗/培养皿数据，纯元数据记录

---

### 5.3 Tab 3：状态

**用途**：更新单个培养皿中花苗的健康状态

| 字段 | 类型 | 说明 |
|------|------|------|
| 培养皿 ID | 扫码/手输 | 如 D-1 |
| 状态 | 下拉 | 正常 / 感染 / 变异 |

**业务规则**：
- 培养皿必须存在且关联有效花苗
- 保存旧状态用于撤销
- 直接更新花苗的 `status` 字段

---

### 5.4 Tab 4：转移

**用途**：将花苗从旧培养皿转移到新培养皿（换皿）

| 字段 | 类型 | 说明 |
|------|------|------|
| 旧培养皿 ID | 扫码/手输 | 必须存在 |
| 新培养皿 ID | 扫码/手输 | 必须不存在，可自动生成 |

**业务规则**：
- 删除旧培养皿记录，创建新培养皿记录
- 更新花苗的 `dishId` 指向新皿
- 花苗本身不变，仅更换物理容器

---

### 5.5 撤销功能

**用途**：撤销当前用户的最近一次操作

**限制条件**：
- 只能撤销自己的操作
- 不能连续撤销（不能撤销一个撤销操作）
- 操作须在 **5 分钟内**，超时不可撤销

**各类型撤销行为**：

| 原操作类型 | 撤销动作 |
|-----------|----------|
| create / split / merge | 删除所有 outputIds 对应的花苗和培养皿 |
| status | 恢复花苗状态为 oldStatus |
| transfer | 删除新皿，恢复旧皿，更新花苗 dishId |
| place | 无操作（纯元数据事件无需撤销） |

---

### 5.6 标签打印（管理页面）

**用途**：生成并打印二维码标签，用于物理标识

**操作流程**：
1. 选择标签类型（培养皿 D- / 盘子 T- / 位置 rack- / 自定义前缀）
2. 设置起始编号和数量（最多 200）
3. 点击"生成标签"生成二维码网格
4. 点击"打印标签"调用浏览器打印

**输出格式**：5 列网格，每格含 120×120px 二维码 + 文字标签

---

### 5.7 事件历史

主页面底部显示两个历史区域：

| 区域 | 说明 | 范围 |
|------|------|------|
| 我的录入历史 | 仅当前用户，最近 20 条 | 按操作人过滤 |
| 事件日志 | 全部事件，最新在前 | 系统全量 |

**功能特性**：
- 按类型下拉过滤：全部、创建、拆分、合并、上架、状态、转移、撤销
- 每条事件可展开查看详情（事件 ID、操作人、完整元数据 JSON）
- 提交操作后自动刷新

---

## 6. 条码扫描

### 6.1 单次扫码

- 点击扫码按钮，打开全屏摄像头覆盖层
- 扫描成功后自动关闭，结果填入目标输入框
- 使用后置摄像头，QR 框 250×250px，10 FPS

### 6.2 连续扫码

- 点击"连扫"按钮，摄像头保持常开
- 每次扫码结果加入队列
- 重复码触发提示"已在队列"
- 扫码间隔冷却：唯一码 800ms，重复码 1500ms
- 设备支持时有振动反馈
- 手动点击"关闭"结束扫码

---

## 7. API 接口

### 7.1 公开接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/health` | 健康检查，返回 `{ ok: true }` |
| POST | `/api/login` | 登录，返回 token 和用户信息 |

### 7.2 需认证接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/logout` | 登出，删除会话 |
| GET | `/api/meta` | 获取元数据（位置、盘子、枚举值） |
| GET | `/api/plants` | 花苗列表，支持 `?query=` 搜索 |
| GET | `/api/dishes` | 培养皿列表，支持 `?query=` 搜索 |
| GET | `/api/events` | 事件列表，支持 `?type=`、`?actorId=`、`?from=`、`?to=` 过滤 |
| POST | `/api/events` | 创建事件（type 字段区分操作类型） |
| POST | `/api/events/undo` | 撤销最近操作 |

### 7.3 管理员接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/admin/users` | 用户列表（不含密码哈希） |

### 7.4 事件类型与 Payload

#### POST /api/events

```json
{ "type": "create", "payload": { "type": "品种A", "stage": "萌发", "count": 3, "trayId": "T-01" } }
{ "type": "split",  "payload": { "parentDishId": "D-1", "count": 3, "trayId": "T-01" } }
{ "type": "merge",  "payload": { "parentDishIds": ["D-1","D-2"], "trayId": "T-01", "targetDishId": "D-100" } }
{ "type": "place",  "payload": { "trayId": "T-01", "locationId": "rack-A1" } }
{ "type": "status", "payload": { "dishId": "D-1", "status": "感染" } }
{ "type": "transfer","payload": { "fromDishId": "D-1", "toDishId": "ND-001" } }
```

---

## 8. 数据库 Schema

```sql
-- 花苗表
CREATE TABLE plants (
  id TEXT PRIMARY KEY,        -- P-1, P-2, ...
  type TEXT NOT NULL,         -- 品种A / 品种B / 合并苗
  stage TEXT NOT NULL,        -- 萌发 / 生长 / 分化
  status TEXT NOT NULL DEFAULT '正常',  -- 正常 / 感染 / 变异
  dishId TEXT                 -- 关联培养皿 ID
);

-- 培养皿表
CREATE TABLE dishes (
  id TEXT PRIMARY KEY,        -- D-1, D-2, ...
  plantId TEXT NOT NULL       -- 关联花苗 ID
);

-- 事件表
CREATE TABLE events (
  id TEXT PRIMARY KEY,        -- UUID
  type TEXT NOT NULL,         -- create/split/merge/place/status/transfer/undo
  actorId TEXT NOT NULL,      -- 操作人用户 ID
  ts TEXT NOT NULL,           -- ISO 8601 时间戳
  inputIds TEXT NOT NULL DEFAULT '[]',   -- JSON 数组
  outputIds TEXT NOT NULL DEFAULT '[]',  -- JSON 数组
  meta TEXT NOT NULL DEFAULT '{}'        -- JSON 对象
);

-- 位置表
CREATE TABLE locations (
  id TEXT PRIMARY KEY,        -- rack-A1, rack-B1, ...
  label TEXT NOT NULL         -- A架-1层-1位
);

-- 盘子表
CREATE TABLE trays (
  id TEXT PRIMARY KEY,        -- T-01, T-02, ...
  label TEXT NOT NULL         -- 盘-01
);

-- 用户表
CREATE TABLE users (
  id TEXT PRIMARY KEY,        -- UUID
  username TEXT NOT NULL UNIQUE,
  passwordHash TEXT NOT NULL, -- scrypt 哈希 (salt.hash)
  role TEXT NOT NULL DEFAULT 'operator'
);

-- 会话表
CREATE TABLE sessions (
  token TEXT PRIMARY KEY,     -- UUID
  userId TEXT NOT NULL,
  userName TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'operator',
  createdAt TEXT NOT NULL,
  expiresAt TEXT NOT NULL     -- 7 天有效期
);
```

---

## 9. 初始种子数据

| 类别 | 数量 | 详情 |
|------|------|------|
| 花苗 | 10 | P-1 ~ P-10，品种A/B 交替，阶段萌发，状态正常 |
| 培养皿 | 10 | D-1 ~ D-10，与花苗一一对应 |
| 位置 | 3 | rack-A1 (A架-1层-1位)、rack-A2、rack-B1 |
| 盘子 | 4 | T-01 ~ T-04 |
| 用户 | 2 | admin (管理员)、demo (操作员) |

---

## 10. 运维管理

### 10.1 常用命令

```bash
npm run dev           # Vite 前端开发服务器 (端口 5173)
npm run dev:server    # Express API 开发服务器 (端口 8787，热重载)
npm run build         # 前端生产构建
npm run deploy        # 构建 + PM2 部署
npm test              # 运行全部测试
npm run backup        # 备份数据库到 backups/ 目录
npm run migrate       # 一次性从 data.json 迁移到 SQLite
npm run add-user -- <用户名> <密码> [角色]  # 添加用户
```

### 10.2 备份与恢复

- 备份输出：`backups/data-{ISO时间戳}.sqlite`
- 建议 crontab 每日凌晨 2 点自动备份
- 恢复：将备份文件覆盖 `server/data.sqlite` 后重启服务

### 10.3 部署

- PM2 配置：单实例，256MB 内存上限，自动重启
- HTTPS 支持：自动检测 TLS 证书文件（mkcert 或 Caddy 反向代理）
- 生产构建输出三个 HTML 入口（主页、登录页、管理页）

---

## 11. 移动端适配

| 特性 | 实现方式 |
|------|----------|
| 最大宽度 | 手机 540px，平板 720px |
| 底部 Tab 栏 | 固定定位，4 个标签 |
| 提交按钮 | 固定在 Tab 栏上方 |
| 安全区适配 | `env(safe-area-inset-bottom)` |
| 触摸优化 | 按钮最小高度 44px |
| 离线检测 | 自动显示"离线中·请检查网络连接"横幅 |
| 重连恢复 | 网络恢复后自动刷新数据和 UI |

---

## 12. 业务不变量与约束

1. 花苗 ID (`P-N`) 全局唯一，自增，不复用
2. 培养皿 ID (`D-N`) 全局唯一，自增，不复用
3. 花苗与培养皿一对一绑定
4. 拆分操作子代继承父代品种和阶段
5. 合并操作产物品种固定为"合并苗"
6. 新创建/拆分/合并的花苗状态默认为"正常"
7. 撤销窗口期为 5 分钟，不可连续撤销
8. 会话有效期 7 天
9. 所有写操作包裹在 SQLite 事务中，保证原子性
10. 事件不可变，仅追加，提供完整审计轨迹
11. `actorId` 由服务端从会话中获取，客户端提交的值被忽略
